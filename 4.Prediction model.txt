import os
import pandas as pd
import numpy as np
from keras.models import load_model
import joblib

# ==== Prediction function ====
def predict_with_model(model_dir, X, has_y_scaler=True):
    print(f"\n‚ñ∂ Loading model directory: {model_dir}")
    model_path = os.path.join(model_dir, "model.h5")
    scaler_x_path = os.path.join(model_dir, "scaler_X.save")
    scaler_y_path = os.path.join(model_dir, "scaler_y.save")

    # Check required files
    if not os.path.exists(model_path) or not os.path.exists(scaler_x_path):
        print(f"‚ùå Missing model or scaler file, skipped: {model_dir}")
        return None, None

    # Load model and scaler
    model = load_model(model_path, compile=False)
    scaler_X = joblib.load(scaler_x_path)

    # Normalize X
    X_scaled = scaler_X.transform(X)

    # Model prediction
    y_pred_scaled = model.predict(X_scaled)

    # Inverse transform y if scaler exists
    if has_y_scaler and os.path.exists(scaler_y_path):
        scaler_y = joblib.load(scaler_y_path)
        y_pred = scaler_y.inverse_transform(y_pred_scaled)
        print(f"‚úÖ Prediction completed (inverse scaled), output shape: {y_pred.shape}")
    else:
        y_pred = y_pred_scaled
        print(f"‚úÖ Prediction completed (raw output), output shape: {y_pred.shape}")

    return y_pred, model_dir


# ==== Read input data ====
data_path = "data2.xlsx"
features = [str(i) for i in range(1, 12)]  # Input feature names: 1‚Äì11

data_df = pd.read_excel(data_path, header=None, names=features, engine="openpyxl")
X = data_df.values
print(f"üìò Input data loaded: {X.shape[0]} rows, {X.shape[1]} columns")

# ==== Model configuration ====
model_configs = [
    ("saved_models/1", True),   # with y scaler
    ("saved_models/2", True),   # with y scaler
    ("saved_models/3", False),  # without y scaler
    ("saved_models/4", False),  # without y scaler
]

# ==== Batch prediction ====
all_predictions = pd.DataFrame(data_df.copy())

for i, (model_dir, has_y_scaler) in enumerate(model_configs, start=1):
    y_pred, model_used = predict_with_model(model_dir, X, has_y_scaler)
    if y_pred is not None:
        for j in range(y_pred.shape[1]):
            all_predictions[f"pred_model{i}_out{j+1}"] = y_pred[:, j]

# ==== Save prediction results ====
output_path = "all_predictions.xlsx"
all_predictions.to_excel(output_path, index=False)
print(f"\nüìÅ All prediction results have been saved to: {output_path}")